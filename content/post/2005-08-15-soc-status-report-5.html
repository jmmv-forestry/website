---
title: "SoC: Status report 5"
date: 2005-08-15 07:05:00 -0400
julipedia: 2005/08/soc-status-report-5.html
excerpt_separator: </p>
---
<p>I started this week's work by reading the first chapters of <a href="http://www.ccrc.wustl.edu/pub/chuck/psgz/diss.ps.gz">Design and Implementation of the UVM virtual memory system</a> to see if I'd learn how to manage anonymous memory. I had been suggested to use anonymous memory objects (aobjs, for short) to store file contents, so I was shown with the task to learn what they are and how to use them. I have to confess that I was afraid of not knowing how to complete the read/write operations for the file-system, because things were very confusing to me even after reading the document. In fact, I spent two or three days reading documentation and code, as well as doing tests, but not doing any real work.</p>  <p>Fortunately, after <i>lots</i> of tests and some <a href="http://mail-index.netbsd.org/tech-kern/2005/08/12/0004.html">words of advice</a> from my mentor, I started to understand how things worked and how aobjs could benefit tmpfs. After two days or so, I had a working implementation of the <tt>read</tt> and <tt>write</tt> hooks, which popped out to be simpler than I thought because most of the work is done by the memory manager. Well... the write operation is less than optimal: it uses the slowest algorithm it'd use to resize aobjs, but is enough for now. Note that it's a must to fix this item (plus several others; see below) before the file-system can be considered "decent".</p>  <p>Aside these two operations, which were my only goal for this week, I managed to complete all other functionality of the file-system. Some of the missing operations were trivial to implement, because the implementations provided by genfs are enough for them. Others, such as the ability to create and use symbolic links, named pipes and special devices, were a bit trickier, but not really difficult. These required refactoring some of the existing code to avoid duplication, which is good because I ended up with cleaner code.</p>  <p>Of special interest was the creation of the <tt>getpages</tt> function. The one in genfs is extremely complex because it's designed to read and write data block by block from a file-system stored on-disk (calling other operations such as <tt>bmap</tt> and <tt>strategy</tt>). In the tmpfs case, this only needs to loan pages from the internal file to the vnode object representing it, a fast operation done internally by UVM. Neat.</p>  <p>Summarizing: tmpfs is (almost) feature complete.  It's now time to <i>optimize</i> it (this is very important), fix some stuff, debug it and write the two documents I promised (as described in the <a href="http://netbsd-soc.sourceforge.net/projects/tmpfs/">project's page</a>).  I've created a little non-exhaustive <a href="http://cvs.sourceforge.net/viewcvs.py/netbsd-soc/tmpfs/TODO?rev=HEAD&amp;view=auto">to-do list</a> to not forget about anything. But if you want, you can start playing with it: just don't expect great performance nor stability. Enjoy!</p><p class="mobile-post"></p>
