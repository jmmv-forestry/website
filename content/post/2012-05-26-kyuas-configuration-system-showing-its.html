---
title: "Kyua's configuration system showing its age"
date: 2012-05-26 22:13:00 -0400
categories:
  - "c++"
  - "kyua"
julipedia: 2012/05/kyuas-configuration-system-showing-its.html
slug: kyuas-configuration-system-showing-its
---
A couple of years ago, when Kyua was still a newborn, I wrote a <a href="http://code.google.com/p/kyua/source/browse/engine/user_files/config.hpp?spec=svn9e8ba29adc79ebb616c1de64105202820642a066&amp;r=f6e156d85199424b0683977d871970d05e964460">very ad-hoc solution</a> for the parsing and representation of its configuration files. The requirements for the configuration were minimal, as there were very few parameters to be exposed to the user. The implementation was quick and simple to allow further progress on other more-important parts of the project. (Yep, quick is an euphemism for dirty: the implementation of the "configuration class" has to special-case properties everywhere to deal with their particular types... just as the Lua script has to do too.)<div><br /></div><div>As I just mentioned in the previous paragraph, the set of parameters exposed through the configuration file were minimal. Let's recap what these are:</div><div><ul><li>Run-time variables: <i>architecture</i> and <i>platform</i>, which are two strings identifying the system; and <i>unprivileged_user</i>, which (if defined) is the name of the user under which to run unprivileged tests as. It is important to mention that the <i>unprivileged_user</i> is internally represented by a data type that includes several properties about a system user, and that it ensures that the data it contains is valid at all times. The fact that every property holds a specific type is an important design requirement.</li><li>Test suite variables: every test suite can accept arbitrary configuration variables. Actually, these are defined by the test programs themselves. All of these properties are strings (and cannot be anything else because ATF test programs have no way of indicating the type of the configuration variables they accept/expect).</li></ul><div>Because of the reduced set of configurable properties, I opted to implement the configuration of the program as a simple data structure with one field per property, and a map of properties to represent the arbitrary test suite variables. The "parser" to populate this structure consists on a Lua module that loads these properties from a Lua script. The module hooks into the Lua metatables to permit things like "<i>test_suites.NetBSD.timeout=20</i>" to work without having to predeclare the intermediate tables.</div><div><br /></div><div>Unfortunately, as I keep adding more and more functionality to Kyua, I encounter additional places where a tunable would be appreciated by the end user (e.g. "disallow automatic line wrapping"). Exposing such tunable through a command-line flag would be a possibility, but some of these need to be permanent in order to be useful. It is clear that these properties have to be placed in the configuration file, and attempting to add them to the current codebase shows that the current abstractions in Kyua are not flexible enough.</div><div><br /></div><div>So, why am I saying all this? Well: during the last few weeks, I have been working on a new configuration module for Kyua. The goals have been simple:</div><div><ul><li>Have a generic configuration module that parses configuration files only, without any semantics about Kyua (e.g. what variables are valid or not). This ensures that the implementation is extensible and at the right level of abstraction.</li><li>Be able to get rid of the ad-hoc parsing of configuration files.</li><li>Allow defining properties in a strictly-typed tree structure. Think about being able to group properties by function, e.g. "kyua.host.architecture"; this is more or less what we have today for test-suite properties but the implementation is a special-case again and cannot be applied to other tunables.</li></ul></div></div><div>And... <drums> I am pleased to say that this code is about to get merged into the tree just in time for Kyua 0.4. In the next few posts, I will explain what the particular design constraints of this new configuration system were and outline a little bit its implementation. I think it's a pretty cool hack that mixes C++ data structures and Lua scripts in a "transparent" manner, albeit you may think it's too &nbsp;complex. The key part is that, <i>as this new configuration module is <b>not</b> specific to Kyua, you might want to borrow the code/ideas for your own use!</i></drums></div>
