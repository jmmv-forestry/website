---
title: "FAM and kqueue"
date: 2004-10-17 17:25:00 -0400
julipedia: 2004/10/fam-and-kqueue.html
excerpt_separator: </p>
slug: fam-and-kqueue
---
<p>The <a href="http://oss.sgi.com/projects/fam/">File Alteration Monitor</a>, or FAM for short, is an utility that monitors changes made to files and directories and delivers asynchronous notifications to applications interested in them. <a href="http://www.gnome.org/">GNOME</a> uses it to keep Nautilus windows in sync with the on-disk contents, among other uses. For example, if you have your home folder open, and you do <tt>touch ~/foo</tt> from a terminal, you can see how the folder immediately updates its status to show the new file.</p>  <p>FAM uses <i>imon</i> internally, a kernel facility found in <a href="http://www.sgi.com/products/software/irix/">IRIX</a> and <a href="http://www.kernel.org/">Linux</a> that provides notifications of changes to files and directories asynchronously (the kernel sends you an event when a change happens). If imon is not supported, it falls back to manual polling: the daemon scans the files being monitored every 6 seconds to see if there have been any changes. Polling is the only way to go if the kernel does not provide you of better ways to receive notifications, but is a suboptimal solution (there is a small time frame where the data hold by the application and the data on-disk differ). And NetBSD, up until now, was using polling.</p>  <p>However, <a href="http://www.netbsd.org/">NetBSD</a> (as well as <a href="http://www.openbsd.org/">OpenBSD</a>) has the <i>kqueue</i> framework, which is similar to imon in functionality. Which are the differences between kqueue and imon? On one hand, kqueue monitors <i>open file descriptors</i>, while imon monitors <i>inodes</i> (this is a problem, as you'll see later). On the other hand, kqueue is handled entirely with system calls, while imon is managed through a pseudo-device (<tt>/dev/imon</tt>).  There are probably many other differences, but these are the main ones AFAICT.</p>  <p>Unfortunately, FAM did not use this interface in these operating systems. This was not acceptable to me (Nautilus with the polling backend is very annoying), so I've been adding support to FAM to work with kqueue. It has not been a trivial task; first, I had to read the kqueue documentation to understand how it worked; I had to understand how the FAM code worked (more or less); and, at last, implement the funcionality (which I've done twice).</p>  <p>The main problem in implementing kqueue support is that FAM is coded with imon and polling in mind, which makes the use of other event notification mechanisms quite difficult. Not to say that the code is not very easy to understand (in fact, some comments in the code tell you that it's messy).</p>  <p>So, what I have done is simulate an imon interface using kqueue.  The <tt>IMonKQueue.c++</tt> file, which you can find <a href="http://cvsweb.netbsd.org/bsdweb.cgi/pkgsrc/sysutils/fam/files/">here</a>, contains a good description on how the "emulation" works (it's not worth to repeat it here). I'd suggest you reading it, testing it, and spotting any errors you find ;-)</p><p class="mobile-post"></p>
