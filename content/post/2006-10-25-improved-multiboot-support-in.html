---
title: "Improved Multiboot support in NetBSD/i386"
date: 2006-10-25 11:09:00 -0400
julipedia: 2006/10/improved-multiboot-support-in.html
excerpt_separator: </p>
slug: improved-multiboot-support-in
---
Back in February this year I <a href="http://julipedia.blogspot.com/2006/02/netbsd-is-now-multiboot-compliant.html">added Multiboot support to NetBSD/i386</a>.  Unfortunately, the implemenation was quite hackish because it required the application of a patch to GRUB-Legacy: the code used the "a.out kludge" present in the Multiboot specification which this bootloader incorrectly omitted in ELF kernels; the patch fixed this issue. However, this prevented booting NetBSD with mainstream GRUB builds (those used by all Linux distributions), thus making this feature mostly useless.<br /><br />The need for the "a.out kludge" came from two different problems:<br /><ul><li>The kernel's ELF image was incorrectly linked because it did not set the correct physical load addresses for the segments it contained, thus GRUB could not load it because it thought there was not enough memory.<br />The "a.out kludge" was used here to tell the boot loader which was the correct address to load the binary image into. Pavel Cahyna <a href="http://mail-index.netbsd.org/source-changes/2006/05/26/0002.html">fixed this issue</a> back in May, removing the need for the hack in this specific case.</li><li>The native boot loader constructs a minimal ELF image that contains the kernel symbol table (ksyms) and sticks it just after the BSS space in memory.  GRUB did not do this so the NetBSD kernel resorted to manually creating this image itself based on the data passed in by GRUB.  In order to be successful, some space was reserved after the BSS section by using the "a.out kludge" (tricking the bootloader to think that this section was larger than it actually was) so that the kernel's bootstrapping process could freely access it. Pavel's fix did not address this problem so, when booting a NetBSD Multiboot kernel with an unpatched GRUB, ksyms did not work.</li></ul>I've now <a href="http://mail-index.netbsd.org/source-changes/2006/10/25/0015.html">finally fixed</a> this long-standing issue appropriately. All the code to create the minimal ELF image is gone and instead the kernel simply moves the data passed in by GRUB to a memory region that is available after bootstrapping. Then, it uses a custom function (<tt>ksyms_init_explicit</tt> instead of <tt>ksyms_init</tt>) which does not need any ELF headers to initialize the ksyms.<br /><br />The results are much clearer and less error-prone code as well as the ability to <span style="font-style: italic;">boot NetBSD straight from a stock GRUB installation</span>! Keep in mind that this will go into 4.0, so setting up dual-boot machines will be easier than ever :-)<br /><br />I've prepared a couple of screenshots for your pleasure.  First, a look at the configuration used to boot a Multiboot-enabled NetBSD kernel:<br /><a href="http://photos1.blogger.com/blogger2/1919/2183/1600/netbsd-grub.png"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer;" src="/images/2006-10-25-netbsd-grub.png" alt="" border="0" /></a>And then a look at the messages printed by the kernel as well as a demonstration that ksyms work by invoking a backtrace in the debugger (ddb):<br /><a href="http://photos1.blogger.com/blogger2/1919/2183/1600/netbsd-ddb.png"><img style="margin: 0px auto 10px; display: block; text-align: center; cursor: pointer;" src="/images/2006-10-25-netbsd-ddb.png" alt="" border="0" /></a>
