---
title: "NetBSD/i386 development under OS X"
date: 2006-04-09 09:41:00 -0400
julipedia: 2006/04/netbsdi386-development-under-os-x.html
slug: netbsdi386-development-under-os-x
---
Mac OS X is the only operating system in my iBook and I have no plans to change this in the near future (installing NetBSD was frustrating and I do not want Linux).  However, I want to be able to do NetBSD development on it shall the need arise.  And it has to be easy.<br /><br />My idea was to have a disk image with NetBSD/i386 on it and to be able to mount it from OS X to manage its contents (e.g. to update its kernel or to install new userland).  Therefore, installing on a Apple UFS file system was a must.  NetBSD can read such file systems but unfortunately it cannot boot from them (as far as I know); hence the need for a little boot FAT partition (see below).<br /><br />As a result I have got a NetBSD/i386 installation under <a href="http://www.kberg.ch/q/">Q</a>, completely manageable from OS X.  The overall setup renders a very nice development environment.<br /><br />Let's see how (not exactly trivial):<ol><li>Get NetBSD sources on your OS X machine.</li><li>Build a cross-compiler toolchain for i386, which basically means <tt>./build.sh -m i386 tools</tt>.  Doesn't build.sh rock?</li><li>Prepare a custom i386 kernel configuration and build it.  You can simply get <tt>GENERIC</tt>, but you <i>must</i> enable <tt>options APPLE_UFS</tt> as well as <tt>options FFS_EI</tt> (thanks to Rudi Ludwig for <a href="http://mail-index.netbsd.org/port-macppc/2006/04/09/0001.html">pointing the latter out</a>).  Do not disable <tt>file-system MSDOS</tt>.</li><li>Create a new PC under Q and specify a new 512MB <i>raw</i> disk image (qcow will not work).</li><li>Use the command line <tt>fdisk</tt> utility to partition the new image: create a 50MB FAT16 partition (type 6) and leave the rest for Apple UFS (type 168).  You may have geometry problems here as <tt>fdisk</tt> will think that the disk is extremely large; for the 512MB disk we just created, use 1040 cylinders, 16 heads and 63 sectors per track (you can give this to fdisk as parameters).</li><li>The disk created by Q is stored in <tt>~/Documents/QEMU/pcname.qvm/Harddisk_1.raw</tt>; I will refer to it as <tt>disk.img</tt> for simplicity.  Tell OS X to attach it: <tt>hdiutil attach -nomount disk.img</tt>.</li><li>Format the new partitions.  <i>WARNING: OS X attaches this as <tt>disk1</tt> for me; check the device name in your  machine before proceeding and adjust it accordingly</i>.  Simply do: <tt>newfs_msdos /dev/disk1s1</tt> and <tt>newfs /dev/disk1s2</tt>.</li><li>Detach the image and reattach it, but this time let OS X mount the file systems within them: <tt>hdiutil detach disk1 ; hdiutil attach disk.img</tt>.</li><li>Use the finder to rename the partitions to more representative names.  E.g. NB-Boot and NB-Root.</li></ol>Now it's time to install NetBSD under the new disk.  We need to do this manually.  Assume that all of the following commands are run from within <tt>/Volumes/NB-Root</tt>:<ol><li>Unpack the NetBSD sets by doing: <tt>for f in ~/NetBSD/i386/binary/sets/[bcegmt]*.tgz; do sudo tar xzpf $f; done</tt>.</li><li>Create the device files in <tt>dev</tt> by executing the following: <tt>cd dev && sudo ./MAKEDEV -m ${TOOLDIR}/bin/nbmknod all</tt>.  <tt>TOOLDIR</tt> points to the directory holding the cross tools you built before.</li><li>Create a minimal <tt>etc/fstab</tt>.  E.g.:<br/><tt>/dev/wd0f / ffs rw 1 2<br/>/dev/wd0e /boot msdos ro,-l 0 0</tt></li><li>Create the <tt>boot</tt> directory.  This clashes with the standard <tt>/boot</tt> file in a NetBSD system, but we will not have this one; feel free to use a different name.</li><li>Edit <tt>etc/gettytab</tt> and add <tt>al=root</tt> to the default entry.  This will automatically log into root's session, so we do not need to set a password for it.</li><li>Edit <tt>rc.conf</tt> and set <tt>rc_configured=YES</tt>.  Disable all the services you will not use for better boot up speed: <tt>cron=NO inetd=NO sendmail=NO virecover=NO wscons=YES</tt>.  Do not forget to set the host name: <tt>hostname=devel</tt>.</li><li>Edit <tt>wscons.conf</tt> and disable all extra screens.</li><li>Create links that will point to the kernels: <tt>ln -s boot/netbsd boot</tt> and <tt>ln -s boot/netbsd.gdb</tt>.  This is the reason why my boot partition is 50MB; the debugging kernels take a lot of space.</li></ol>At last, we need to install the boot loader in the FAT partition.  I've chosen GRUB so I needed a GRUB boot floppy (an image) at hand to finish the setup.<ol><li>Mount the GRUB image and copy its files to the boot partition.  E.g.: <tt>cp -rf /Volumes/GRUB/boot /Volumes/NB-Boot</tt>.  You need the <tt>fat_stage1_5</tt> file for this to work.</li><li>Create a minimal <tt>/Volumes/GRUB/boot/grub/menu.lst</tt> file for automatic booting:<br/><tt>default 0<br/>timeout 5<br/>title NetBSD - Development kernel<br/>kernel (hd0,0)/netbsd root=wd0f</tt></li><li>Copy the kernel you built at the beginning to <tt>/Volumes/GRUB/netbsd</tt>.</li><li>Detach all the disk images: <tt>hdiutil detach disk1</tt> and <tt>hdiutil detach disk2</tt>.<li>Configure your virtual PC in Q to boot from this GRUB floppy disk image and embed GRUB into your virtual hard disk: <tt>root (hd0,0)</tt> and <tt>setup (hd0)</tt>.</li><li>Change Q's configuration to boot straight from the hard disk image.</li></ol>And at last... <b>Boot NetBSD!</b><br /><br />With this setup you can mount your development image with <tt>hdiutil attach disk.img</tt>, mess as you want with its contents, detach it and relaunch your Q session.  Pretty neat :-)
