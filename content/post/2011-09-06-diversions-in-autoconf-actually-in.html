---
title: "Diversions in Autoconf (actually, in M4sugar)"
date: 2011-09-06 18:05:00 -0400
categories:
  - "atf"
  - "autoconf"
  - "m4"
julipedia: 2011/09/diversions-in-autoconf-actually-in.html
slug: diversions-in-autoconf-actually-in
---
Have you ever wondered how Autoconf reorganizes certain parts of your script regardless of the order in which you invoke the macros in your <tt>configure.ac</tt> script? For example, how come you can define <tt>--with-*</tt> and <tt>--enable-*</tt> flags anywhere in your script and these are all magically moved to the option-processing section of the final shell script? After all, Autoconf is just a collection of M4 macros, and a macro preprocessor's only work is to expand macros in the input with predefined output texts. Isn't it?<br /><br />Enter <a href="http://www.gnu.org/s/hello/manual/autoconf/Diversion-support.html#Diversion-support">M4sugar's diversions</a>. Diversions are a mechanism that allows M4 macros to output code to different text blocks, which are later concatenated in a specific order to form the final script.<br /><br />Let's consider an example (based on a few M4 macros to <a href="http://mtn-host.prjek.net/viewmtn/atf/revision/file/7ae5fa10200ec66c26f08c27e4aeaf3facf3f031/atf-c/atf-common.m4">detect the ATF bindings</a> from your own configure scripts). Suppose you want to define a macro <tt>FROB_ARG</tt> to provide a <tt>--with-frob</tt> argument whose argument must be either "yes" or "no". Also suppose you want to have another macro <tt>FROB_CHECK</tt> to detect whether <tt>libfrob</tt> exists. Lastly, you want the user to be able to use these two independently: when <tt>FROB_CHECK</tt> is used <i>without</i> invoking <tt>FROB_ARG</tt> first, you want it to unconditionally look for the library; otherwise, if <tt>FROB_ARG</tt> has been used, you want to honor its value.<br /><br />We could define these macros as follows:<br /><br /><pre>AC_DEFUN([FROB_ARG], [<br />&nbsp;&nbsp;&nbsp; AC_ARG_WITH([frob],<br />&nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [AS_HELP_STRING([--with-frob=yes|no], [enable frob])],<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [with_frob=${withval}, [with_frob=yes]) <br />])<br /><br />AC_DEFUN([FROB_CHECK], [<br />&nbsp; &nbsp; m4_divert_text([DEFAULTS], [with_frob=yes])<br /><br />&nbsp; &nbsp; if test "${with_frob}" = yes; then<br />&nbsp; &nbsp; &nbsp; &nbsp; ... code to search for libfrob ... <br />&nbsp;&nbsp;&nbsp; elif test "${with_frob}" = no; then<br />&nbsp; &nbsp; &nbsp; &nbsp; :&nbsp; # Nothing to do. <br />&nbsp;&nbsp;&nbsp; else<br />&nbsp; &nbsp; &nbsp; &nbsp; AC_MSG_ERROR([--with-frob must be yes or not]) <br />&nbsp;&nbsp;&nbsp; fi<br />])</pre><br />Note the <tt>m4_divert_text</tt> call above: this macro invocation tells M4sugar to store the given text (<tt>with_frob=yes</tt>) in the <tt>DEFAULTS</tt> diversion. When the script is later generated, this text will appear at the beginning of the script before the command-line options are processed, completely separated from the shell logic that consumes this value later on.<br /><br />With this we ensure that the <tt>with_frob</tt> shell variable is always defined regardless of the call to the <tt>FROB_ARG</tt> macro. If this macro is called, <tt>with_frob</tt> will be defined during the processing of the options and will override the value of the variable defined in the <tt>DEFAULTS</tt> section. However, if the macro has not been called, the variable will keep its default value for the duration of the script.<br /><br />Of course, this example is fictitious and could be simplified in other ways. But, as you can see in the <a href="http://mtn-host.prjek.net/viewmtn/atf/revision/file/7ae5fa10200ec66c26f08c27e4aeaf3facf3f031/atf-c/atf-common.m4">referred change</a> and in the Autoconf code itself, diversions are extensively used for trickier purposes. In fact, Autoconf uses diversions to topologically sort macro dependencies in your script and output them in a specific order to satisfy cross-dependencies.<br /><br />Isn't that cool?&nbsp; I can't cease to be amazed, but I also don't dare to look at how this works internally for my own sanity...
