---
title: "pkg-config: Sanity-checking package dependencies"
date: 2005-05-21 15:44:00 -0400
julipedia: 2005/05/pkg-config-sanity-checking-package.html
excerpt_separator: </p>
---
<p>A while ago, I posted a series of <a href="http://pkgconfig.freedesktop.org/wiki/">pkg-config</a> related messages: <a href="http://www.livejournal.com/users/jmmv/28801.html">1</a>, <a href="http://www.livejournal.com/users/jmmv/29187.html">2</a> and <a href="http://www.livejournal.com/users/jmmv/30595.html">3</a>. They were intended to give some background knowledge about that program, to let me easily explain something else: how pkg-config can be used to sanity-check packages â€” that is, to ensure that the libraries they depend on are the correct ones.</p>  <p>In <a href="http://www.pkgsrc.org/">pkgsrc</a>, <i>direct</i> dependencies are specified by including special <tt>buildlink3.mk</tt> files. These files have a default version specification in them, so that a reasonable value is kept somewhere centralized. For example, in the current tree, when you include glib2's <tt>buildlink3.mk</tt> file, you get a dependency such as <tt>glib2&gt;=2.6.1</tt>.  So far so good.</p>  <p>Now suppose that you are packaging a program which requires, at least, version 2.6.4. You need to make sure that the new package specifies that, like in <tt>glib2&gt;=2.6.4</tt>, to avoid problems if an older version is installed. The problem is that manually checking this is very difficult; if the developer has the required version (2.6.4) already installed, he won't notice that the configuration script is requiring a newer version than the one specified in the <tt>buildlink3.mk</tt> file.</p>  <p>Similar problems arise with <i>indirect</i> dependencies.  Consider a package which requires libgnomeui and gtk2.  If this package includes libgnomeui's <tt>buildlink3.mk</tt> file alone, it will build correctly, because this will automatically pull in gtk2's <tt>buildlink3.mk</tt> file. However, this is incorrect, because the resulting binary package will miss a direct dependency on gtk2. Discovering these issues is quite difficult.</p>  <p>The thing is that I have found a way to notice these problems in an automated fashion (rather than manually reviewing tons of code in configuration scripts). Given that the <tt>configure</tt> scripts (usually) call pkg-config for each direct dependency, it's a matter of capturing these calls, storing them in a log file to compare them later on with the package's specification files.</p>  <p>To achieve this, I've written a little patch for pkg-config which makes it write a log file with all the queries it receives and their results. Then, I've made pkgsrc use the patch to generate such file inside <tt>WRKDIR</tt>.  And finally, I've written a script, called <tt>verifypc</tt>, that compares the log file with what the package's <tt>Makefile</tt> contains.</p>  <p>It saves me a lot of time when updating packages to newer versions, as I can quickly see if I need to modify the dependencies. However, the script still has multiple problems (such as thinking that 2.9 is newer than 2.10) and, frankly, is very ugly. I guess I'll have to clean up this stuff and include it in pkgsrc ;)</p><p class="mobile-post"></p>
