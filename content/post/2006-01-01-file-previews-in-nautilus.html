---
title: "File previews in Nautilus"
date: 2006-01-01 12:54:00 -0500
julipedia: 2006/01/file-previews-in-nautilus.html
excerpt_separator: </p>
---
Yesterday's evening, I was organizing some of my pictures when I noticed that Nautilus wasn't generating previews for any of them.  This annoyed me so much that I decided to track down the issue, which I've done today.<br /><br />The first thing I did was to attach a gdb session to the currently running Nautilus process, adding some breakpoints to the functions that seemed to generate preview images; I located them using grep(1) and some obvious keywords.  This wasn't very helpful, but at least I could see that the thumbnail generation routine checks whether the file is local or not (because Nautilus lets you set different preferences for them).<br /><br />With this in mind, I resorted to the traditional and not-so-elegant <tt>printf</tt> debugging technique (which, with pkgsrc in the middle, is quite annoying).  Effectively, a call to <tt>gnome_vfs_uri_is_local</tt> was always returning false, no matter which file it was passed.  It was clear that the problem was in gnome-vfs itself.<br /><br />So I switched to the gnome-vfs code, located that function and saw that it was very short: basically, all it does is delegate its task to another function that depends on the <i>method</i> associated to the file &mdash; you can think of the method as the protocol that manages it.  As I was accessing local files, the method in use was the file method (implemented in <tt>modules/file-method.c</tt>), so the affected function was, how not, its <tt>do_is_local</tt>.<br /><br />As it is a bit complex (due to caching issues for efficiency), I added some more printfs to it to isolate a bit more the problem, which drove me to the <tt>filesystem_type</tt> function implemented in <tt>modules/fstype.c</tt>.  And man, when looking at this function I quickly understood why it was the focus of the problem.  It is so clumsy &mdash; portability-wise &mdash; that it is very easy for it to break under untested circumstances: it is composed of a set of mutually exclusive ifdefs (one for each possible situation) to determine the file system name in which a file lives.<br /><br />And you guessed right: NetBSD 3.x didn't match any of them, so it resorted to a default entry (returning an <tt>unknown</tt> file system type) that is always treated as remote by the file method code.<br /><br />The solution has been to workaround the detection of one of these special cases in the configure script to properly detect statvfs(2) under NetBSD.  This is just a hack that adds to the uglyness of the original code, but fixing this issue properly will require a lot of work and the willingness of the gnome-vfs maintainers to accept the changes.<br /><br />I will ask for a pull-up to the pkgsrc-2005Q4 branch when I've been able to confirm that this does not break on other NetBSD versions.  Now have fun watching your images again! ;-)
