---
title: "NFS exports lists rototill"
date: 2005-09-23 08:35:00 -0400
julipedia: 2005/09/nfs-exports-lists-rototill.html
slug: nfs-exports-lists-rototill
---
<p>After two weeks of work, the NFS exports lists rototill that I briefly outlined in <a href="http://www.livejournal.com/users/jmmv/43121.html">this past post</a> is finished and committed into <a href="http://www.netbsd.org/">NetBSD</a>'s source tree. Believe it or not, the whole set of changes was triggered by a XXX mark in mountd(8)'s code (in other words, fixing code marked as such is not always trivial).</p>  <p>In the past, when a file system wanted to support NFS, it had to include two fields in a fixed position of its mount arguments structure due to the broken way in which mountd(8) handled the mount(2) calls. Furthermore, each file system had to deal internally with the NFS exports list, duplicating code among all NFS-aware file systems; this feature was clearly generic, so it had to be placed in an upper generalization level. At last, you had to use the mount(2) system call in a wired way to change the exports.</p>  <p>This was wrong because it broke extensibility and <a href="http://www.netbsd.org/Goals/system.html">code cleanliness</a>: you couldn't add a new NFS-aware file system without modifying and rebuilding mountd(8). There was also a lot of code duplication and the interface was just ugly from a design point of view. It looked like a quick band-aid over old code to add support for more than one NFS-aware file system.</p>  <p>The changes I just committed have centralized all NFS exports lists handling in a single place and it has been removed from the kernel's core. This stuff is now only compiled in when the <tt>NFSSERVER</tt> option is enabled, reducing the final kernel size by around 5KB.</p>  <p>The next logical step is to rework mountd(8) to update the whole exports list for a given mount point atomically; this wasn't possible at all before. The new kernel interface, introduced as a new command to the nfssvc(2), has been designed to support this functionality, although it's not used yet due to the big changes required in the userland utility. I won't be working on this anytime soon, as I have other stuff to do before it (hence the entry I added to src/TODO).</p>  <p>If you want to know a bit more, the <a href="http://mail-index.netbsd.org/source-changes/2005/09/23/0002.html">commit message</a> contains a detailed list of all the changes.</p>  <p>PS: I have to thank Google's Summer of Code 2005 again. I couldn't have found this issue nor had enough knowledge to fix it if I hadn't been working on tmpfs during the summer.</p><p class="mobile-post"></p>
