---
title: "vr(4) problems"
date: 2005-01-23 11:49:00 -0500
julipedia: 2005/01/vr4-problems.html
slug: vr4-problems
---
<p>Since I started using the <tt>vr(4)</tt> driver (i.e., when I switched my network to twisted pair cables), I've been experiencing very annoying crashes when running in promiscuous mode. This happened rarely at boot up, while <tt>dhclient(8)</tt> fetches its first lease.  However, if you happen to use any other utility that puts the NIC in promiscuous mode, such as <tt>tcpdump(8)</tt> or <tt>bridge(4)</tt>, the crashes happen almost 95% of the times.</p>  <p>Yesterday, I got up decided to fix this issue (mainly because I need to set up a bridge). Oh well, what a crazy decision. I spent the whole day tracking down the problem; it took so long because I didn't know anything about the kernel's networking code and because <a href="http://www.gnu.org/software/gdb/">GNU gdb</a> did strange things.</p>  <p>After dealing with the kernel core dump and reading a big amount of code, I started to understand what was going on. (I can say that I learned <i>a lot</i> during the process, although I am still missing many, many details.)  And finally I isolated the problem.</p>  <p>For some reason, the card is producing zero-length packets with some unusual flags active. I guess these are raised to notify the driver about a special condition but, without the card specs (they used to be public, but now you have to fill in a form and wait for confirmation to get them), it is very difficult to know what's going on. FWIW, I looked at the Linux driver and they simply ignore these packets. Basically, they assume that if a packet does not have the <i>first fragment</i> nor the <i>last fragment</i> bits set, it's incorrect.</p>  <p>So I've done a patch that discards these packets, just as Linux does.  You can find it in <a href="http://mail-index.netbsd.org/tech-kern/2005/01/22/0007.html">this thread</a> (the first one is incorrect; the second one is almost correct, except the assertion). I'm waiting to do a bit more testing locally to later commit the patch.</p>  <p>However, I think I still haven't found the root of the problem. All this patch does is add some more sanity checks, but those zero-length packets shouldn't be generated at all (according to what I see in Linux when reproducing a similar scenario).</p><p class="mobile-post"></p>
