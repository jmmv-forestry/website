---
title: "Testing NetBSD's share/mk"
date: 2012-08-26 22:18:00 -0400
categories:
  - "netbsd"
  - "testing"
julipedia: 2012/08/testing-netbsds-sharemk.html
excerpt_separator: </p>
---
For a long time, a pet peeve of mine has been the lack of tests for the build infrastructure files of NetBSD: i.e. those <tt>bsd.*.mk</tt> files that live under <tt>/usr/share/mk/</tt> and on which the whole source tree depends.<br /><br />One could argue that writing tests for these files is not strictly necessary because the successful build of NetBSD is the real final test of whether the files work or not. That's partly true, but unfortunately is not the whole story:<br /><ul><li>Other projects depend on these build files and thus rely on their behavior. This can either be by just relying on NetBSD having these files installed, or by using the separate <tt>mk-files</tt> package (available e.g. in Fedora). The functionality of the build infrastructure should not regress, or it would break these third-party projects. (Think about these files as having a public API outside of NetBSD.)</li><li>Even if the build of NetBSD is the real test of the functionality of the build infrastructure, the build infrastructure supports dozens of options and tweaks to change its behavior. One would need to rebuild NetBSD tens, if not hundreds of times, each with a different combination of build options, to ensure the files work.</li><li>Lastly, when a new functionality is added to the build infrastructure, it is because some component of the source tree needs such functionality. It may latter happen that this component disappears or stops needing such functionality. The functionality becomes unused by the source tree, and thus can regress unexpectedly (breaking third-party packages or introducing bugs, as mentioned earlier).</li></ul>With this in mind, it's clear that we should have some tests for the <tt>share/mk</tt> files. Unfortunately, that's easier said than done:&nbsp;the files in <tt>share/mk</tt> are extremely complex and expose hundreds, if not thousands, of different behaviors each with its own subtleties. Adding tests for these is hard. The fact that this code that was never designed to be unit-tested doesn't help either.<br /><div><br />Regardless, I have just&nbsp;<a href="http://mail-index.netbsd.org/source-changes/2012/08/26/msg036875.html">submitted some "placeholder" tests</a>&nbsp;to the tree. The major point of these new test programs is&nbsp;to lower the barrier of entry to writing tests for <tt>share/mk</tt> and, therefore, maybe get other people to write some tests. To predicate with the example, I have populated these skeleton test programs with a couple of test cases each, although as you will see they are very trivial tests.<br /><br />And, to conclude, why have I done this <i>now</i>? Well: I'm working on integrating Kyua into the source tree and, to make this happen, I need to do a couple of changes to the build infrastructure files. The changes are tricky, so I want to write tests to have some assurance that my modifications work and that, specially, they do not regress over time. Having the placeholder test programs in place makes this much easier, and the real functionality changes easier to review.</div>
