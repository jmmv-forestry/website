---
layout: post
title: "NetBSD: File system directories, part 1"
date: 2005-11-17 06:41:00 -0500
categories:
julipedia: 2005/11/netbsd-file-system-directories-part-1.html
excerpt_separator: </p>
---
A file-system directory is an object that maps file names to nodes (i-nodes in UFS terminology). When given a file name, the directory must be able to tell whether it has that name or not and return the node number attached to it. File names are not stored in the nodes themselves as this allows for hard link creation flawlessly: you can have multiple directory entries pointing to the same file with no extra cost.<br /><br />Let's see a very simple directory implementation, coming from <a href="http://www.NetBSD.org/">NetBSD</a>'s tmpfs (see <a href="http://cvsweb.netbsd.org/bsdweb.cgi/src/sys/fs/tmpfs/tmpfs.h?rev=HEAD&content-type=text/x-cvsweb-markup">tmpfs.h</a>). This file system implements directories by using a linked list (<tt>struct tmpfs_dir</tt>) of directory entries (<tt>struct tmpfs_dirent</tt>). These structures look like:<pre>struct tmpfs_dirent {<br />        TAILQ_ENTRY(tmpfs_dirent) td_entries;<br />        uint16_t td_namelen;<br />        char *td_name;<br />        struct tmpfs_node *td_node;<br />};<br />TAILQ_HEAD(tmpfs_dir, tmpfs_dirent);</pre>Of special interest are the <tt>td_name</tt> field, which holds the entry name (file name), and the <tt>td_node</tt> pointer, which points to the file system node related to this directory entry (UFS could use i-node numbers instead).<br /><br />This implementation is really simple as it is completely backed by virtual memory; adding and removing entries is as easy as allocating a memory block and modifying the linked list accordingly. It could, of course, be more complex if it used a B+ tree or some other structure instead.<br /><br />However, on-disk file systems do extra tasks to optimize directory accesses. For example, when an entry is removed, it is marked as deleted using a special flag but it is not really removed from disk, because shrinking the directory could be expensive. Similarly, new entries overwrite previously deleted entries, if possible.<br /><br />In the next post, we will outline how some directory operations (such as <tt>lookup</tt> and <tt>readdir</tt>) work.<br /><br />Post suggested by Pavel Cahyna.
