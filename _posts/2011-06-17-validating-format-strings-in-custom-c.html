---
layout: post
title: "Validating format strings in custom C functions"
date: 2011-06-17 11:40:00 -0400
categories: c
julipedia: 2011/06/validating-format-strings-in-custom-c.html
excerpt: Post imported from The Julipedia; excerpt not available.
---
In C, particularly due to the lack of dynamic strings, it's common to pass format strings around together with a variable set of arguments. A prototype like this is very common:<br /><br /><tt>void&nbsp;my_printf(const char*, ...);</tt><br /><br />For the standard <tt>printf</tt> and similar functions, some compilers will ensure that the variable list of arguments matches the positional parameters in the format string and, if they don't match, raise a warning. &nbsp;This is, however, just a warning "hardcoded" to match these functions, as the compiler can't know how the variable arguments of our custom <tt>my_printf</tt> function relate to the first argument.<br /><br />Or can it?<br /><br /><a href="http://mail-index.netbsd.org/source-changes/2011/06/11/msg023084.html">I was made aware</a> of a nice GCC attribute that allows developers to tag printf-like functions in a manner that allows the compiler to perform the same validation of variable arguments and format strings. &nbsp;This is in the form of a GCC <tt>__attribute__</tt> that also happens to work with CLang. &nbsp;Let's see an example to illustrate how this works:<br /><br /><pre>#include &lt;stdarg.h&gt;<br />#include &lt;stdio.h&gt;<br /><br />static void my_printf(const char*, ...)<br />&nbsp; &nbsp; __attribute__((format(printf, 1, 2)));<br /><br />static void<br />my_printf(const char* format, ...)<br />{<br />&nbsp; &nbsp; va_list ap;<br /><br />&nbsp; &nbsp; printf("Custom printf: ");<br />&nbsp; &nbsp; va_start(ap, format);<br />&nbsp; &nbsp; vprintf(format, ap);<br />&nbsp; &nbsp; va_end(ap);<br />}<br /><br />int<br />main(void)<br />{<br />&nbsp; &nbsp; my_printf("this is valid %dn", 3);<br />&nbsp; &nbsp; my_printf("but this is not %fn", 3);<br />}</pre><br />If we compile the code above:<br /><br /><pre>$&nbsp;clang example.c<br />example.c:22:33: warning: conversion specifies type 'double' but<br />the argument has type 'int' [-Wformat]<br />&nbsp; &nbsp; my_printf("but this is not %fn", 3);<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;~^ &nbsp; &nbsp; ~<br />1 warning generated.</pre><div><br /></div><div>Very useful. &nbsp;This function attribute has been applied to many functions in the NetBSD tree and many bugs have been spotted thanks to it.</div><div><br /></div><div>Instead of me explaining how the format attribute works, I'll refer you to the <a href="http://gcc.gnu.org/onlinedocs/gcc/Function-Attributes.html#Function-Attributes">official documentation</a>. The attribute recognizes several format styles and takes different arguments depending on them, so it is a bit tricky to explain. Plus, if you look at the extensive list of attributes, you may find some useful stuff ;-)</div><div><br /></div><div>Happy debugging!</div>
