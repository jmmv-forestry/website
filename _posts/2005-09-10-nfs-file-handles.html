---
layout: post
title: "NFS file handles"
date: 2005-09-10 05:31:00 -0400
categories:
julipedia: 2005/09/nfs-file-handles.html
excerpt: Post imported from The Julipedia; excerpt not available.
---
<p>NFS uses a structure called a <i>file handle</i> to uniquely identify exported files. When a client requests to access a file, the server constructs a file handle that identifies it; from this point on, this identifier will be used in all communications between the server and the client to access that specific file. (Look at the <tt>fs_vptofh</tt> and <tt>fs_fhtovp</tt> hooks in <a href="http://www.netbsd.org/">NetBSD</a>'s VFS layer to see how this mapping works.)</p>  <p>In order to identify a file univocally, you need three things: the file-system identifier (i.e., something unique to each mount point), the node number (e.g., the inode number in FFS terminology) and a generation number. It is clear why the first two are needed, but the generation number may be confusing. In order to explain this last concept, let's see an example:</p>  <p>Suppose you have a file using the 1234 inode of the root file-system; let's call this <tt>foo</tt>.  Now, you delete <tt>foo</tt> and create a new file, called <tt>bar</tt>, which ends up <i>reusing</i> the 1234 inode. These two files are clearly different, but they could look the same from the point of view of a file handle if you used the file-system number and the inode number exclusively. Therefore, we need a third component, the generation number, that makes these two files different. This component is incremented each time an inode is reused for a different file.</p>  <p>So far, so good. But now we get to the ugly part: given a file-system number, a node number and a generation number, you can generate a file handle that refers to any file within the exported file-system. If these values were available to everybody, a malicious client could easily generate file handles to access files he is not allowed to touch. This is why the generation number is hidden to user space: if you apply <tt>stat(2)</tt> to a file, you'll always get a zero value in the <tt>st_gen</tt> field (some systems may return the correct number if you are root).  Similarly, the <tt>getfh(2)</tt> system call is restricted to the super-user.</p>  <p>But can't a user guess the generation number? Yes, he can. This is why they are often generated based on a random seed, which makes the guessing difficult. See <tt>fsirand(8)</tt> for more information.</p>  <p>All this explains why there is no such thing as exporting a subtree in the NFS world. When you export a directory from a file-system, you are implicitly exporting the whole mount point because malicious file handles could be used to access files outside the subtree.</p>  <p>Thanks go to William Studenmund for explaining me this during <a href="http://netbsd-soc.sourceforge.net/projects/tmpfs/">tmpfs</a> development.</p><p class="mobile-post"></p>
