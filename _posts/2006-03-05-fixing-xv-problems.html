---
layout: post
title: "Fixing xv problems"
date: 2006-03-05 12:39:00 -0500
categories:
julipedia: 2006/03/fixing-xv-problems.html
excerpt_separator: </p>
---
As you may already know I <a href="http://julipedia.blogspot.com/2006/01/got-benq-fp202w-flat-panel.html">bought a BenQ FP202W</a> flat panel two months ago, which made me switch from a rather small resolution (1024x768) to a much bigger one: 1680x1050 at 24bpp running on a NVIDIA GeForce 6600GT with the free nv driver.  As I did the switch I lost the ability to play videos in X11 full screen mode because the Xvideo refused to work.  As you can imagine, this was <i>extremely annoying</i>.<br /><br />For example, mplayer spit out the following:<br /><br /><tt>X11 error: BadAlloc (insufficient resources for operation)?,?% 0 0</tt><br /><br />Similarly, xawtv couldn't set up an overlay window due to the lack of the xv extension thus becoming completely unusable.<br /><br />Based on a suggestion from someone I don't remember, I decided yesterday to replace my XFree86 4.5.0 installation with X.Org 6.9 hoping that its nv driver could work better.  Guess what, it didn't.<br /><br />But after the installation, and just out of curiosity, I started looking at nv's sources to see if I could discover the problem.  I was hopeless to find a solution but I had to try.<br /><br />First of all, I grepped for <tt>BadAlloc</tt> in the nv directory, something that quickly drove me to the <tt>NVAllocateOverlayMemory</tt> function.  Based on the name, this seemed like a logic place for the failure.  I added some debugging messages, reinstalled the driver and effectively this function was being called and returned a null pointer.<br /><br />Some more printf's told me that the problem was being raised by <tt>xf86AllocateOffscreenLinear</tt>.  "Ouch... looks as if the driver cannot allocate enough video memory for such a big resolution... may be difficult to fix", I though.  Nevertheless, I continued my quest inspecting this other function and many other code in xf86fbman.c.  Along the process, I discovered a <a href="https://bugs.freedesktop.org/show_bug.cgi?id=6150">minor, unrelated bug</a> probably caused due to a pasto.  Overall, the code is quite confusing if you are X-clueless, just as I am.<br /><br />After a couple of hours or so I was looking at the <tt>localAllocateOffscreenLinear</tt> function.  I saw that the first call to <tt>AllocateLinear</tt> was returning a null pointer, which made me think that the problem was there, continuing the inspection in that direction.  That lead to nowhere.<br /><br />At last, and tired of try & error cycles, I returned to the <tt>NVAllocateOverlayMemory</tt> function.  I saw there that calls to <tt>xf86AllocateOffscreenLinear</tt> function were passing a 32 value, which seemed like a bpp.  "Hmm... if I decrease it to, say, 24, it may need less memory and it might work."  And indeed it did!  That little change enabled xv again in my machine.<br /><br />But the rationale behind the change was wrong.  It happens to be that that parameter is not a bpp; it is a <i>granularity</i>.  Therefore I assume that the less its value, the better.  Some other greps "confirmed" this, as other drivers such as radeon are using a value of 16 (or even less) for that call.<br /><br />Some time later and with xv working properly, I came back to the <tt>localAllocateOffscreenLinear</tt> function.  This made me see that it was always falling back to the second case (below the "NOPE, ALLOCATING AREA" message).  "Stupid me; I should have looked there before."  This is part of the function:<pre>if(gran && ((gran > pitch) || (pitch % gran))) {<br />   /* we can't match the specified alignment<br />      with XY allocations */<br />   xfree(link);<br />   return NULL;<br />}</pre><tt>gran</tt> is the granularity passed in by the driver and <tt>pitch</tt> seems to be the screen's horizontal resolution.  So, doing some numbers we see that <tt>pitch % gran = 1680 % 32 = 16 != 0</tt>.  Voila!  There it is, the real problem.  Well, I <i>think</i> this is the problem, but I may be wrong.<br /><br />After all, it looks like as if the problem was a simple bug rather than something related to the card's memory.  You can <a href="https://bugs.freedesktop.org/show_bug.cgi?id=6151">follow this bug</a> for more information as well as to retrieve the proposed patch.<br /><br /><b>Edit (March 6, 21:38)</b>: It turns out my patch was not really correct.  For more information just check out the bug's audit trail.
