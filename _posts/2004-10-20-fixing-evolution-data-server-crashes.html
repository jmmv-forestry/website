---
layout: post
title: "Fixing Evolution Data Server crashes"
date: 2004-10-20 06:55:00 -0400
categories:
julipedia: 2004/10/fixing-evolution-data-server-crashes.html
excerpt_separator: </p>
---
<p>Yesterday, I packaged evolution-webcal (which was a trivial task), but, as I expected, it didn't work. In fact, I realised that neither the contacts view nor the calendar view of Evolution 2.0 were working at all. I could see the components, but I couldn't interact with them. So I started to debug the problem.</p>  <p>In the console, there were several warnings printed out by Evolution that told it couldn't activate some bonobo component coming from Evolution Data Server. Uhm... ok; I searched through the code for that message, noted which function it was in and launched Evolution through gdb, adding a breakpoint in that function.</p>  <p>When the breakpoint was triggered, I saw strange things: the backtrace only contained two frames. Of these, a string parameter in frame 0 was null. "Oh, that must be the problem", I thought. Stupid me. Switched to frame 1 and saw that the string was, in fact, correct. "Ew, looks like something is going wrong in gdb". So I added several <tt>printf(3)</tt>'s in the code to check the pointer's value.  All of them were correct; no null pointers anywhere.</p>  <p>My next thought was that gdb 5.3 (the version that comes with NetBSD) does not handle threads correctly, which made me install gdb 6.2.1 from pkgsrc. Hmm, this one has some nice features, like setting a breakpoint in a function that is still not loaded (which will be resolved when the shared library that contains it is opened). But it still showed me incorrect traces and parameters. Unfortunately, after many attempts, I had to forget about gdb. I don't know if I'm missing something or it doesn't support NetBSD threading correctly yet.</p>  <p>So I kept debugging with <tt>printf(3)</tt>'s, trying to understand why the call to <tt>bonobo_activation_activate_from_id</tt> (which I had already isolated) was returning an error. Well, better said, it returned no objects, because it was not handling errors at all (something that'd have saved me a lot of trouble).</p>  <p>Did some more tests but got bored quickly: rebuilding Evolution and running it from the source tree is not fun. Solution: create a small test case that calls the failing function with the same parameters. This took a bit of time because I had to do some research about the bonobo-activation and libbonobo APIs. But after all, I got it. And hopefully, it behaved as expected: it failed to load the components! Throwing <tt>OAFIID:GNOME_Evolution_DataServer_InterfaceCheck</tt> to the function made it fail, while picking a non-evolution-related component worked properly (I tried with <tt>OAFIID:Fontilus_Context_Menu_Factory</tt>).  Ok, now, to look for differences between these two to see why one failed but not the other.</p>  <p>After several stupid tests, I added better error control to my test case and got a message that said something like: <i>Cannot read from child process</i>.  Yay!  This gave me the final clue.</p>  <p>Executed <tt>/usr/pkg/libexec/evolution-data-server-1.0</tt> by hand and could see it dumping core.  <tt>ktrace(1)</tt>'d it and saw it was calling a NetBSD 1.3 compatibility function. Huh? Tried with gdb, which this time was useful: I could see that the last call before the segfault was related to <tt>sigaction(2)</tt> and could get an useful call trace.</p>  <p>Inspected the code, tried to disable the signalling stuff and it ran properly! "Wow, I'm really close to the bug", I thought. Afterwards, I reenabled it, and while compiling the affected file, I could see a related warning that I'd never noticed before:</p>  <tt>server.o(.text+0x109): In function `main':</tt><tt><br />/home/jmmv/NetBSD/pkgsrc/mail/evolution-data-server/work/<br />evolution-data-server-1.0.2/src/server.c:129: warning: reference to compatibility sigemptyset(); include &lt;signal.h&gt; for correct reference</tt>  <p>And here is the solution: added <tt>#include &lt;signal.h&gt;</tt> to the server.c file and everything worked properly. Evolution Data Served does not dump core any more and Evolution 2.0 works quite well. Isn't this one of the most stupid fixes you can think about?</p>  <p>I'm still surprised that the lack of a header file caused these kind of problems at <i>run time</i>. Guess I'll have to investigate a bit more why this happens. But not now; this took me more than two hours to discover and fix!</p><p class="mobile-post"></p>
