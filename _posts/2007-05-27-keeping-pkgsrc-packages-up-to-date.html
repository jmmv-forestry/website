---
layout: post
title: "Keeping pkgsrc packages up to date"
date: 2007-05-27 14:26:00 -0400
categories: pkgsrc update
julipedia: 2007/05/keeping-pkgsrc-packages-up-to-date.html
excerpt: Post imported from The Julipedia; excerpt not available.
---
drio asks in the <a href="http://julipedia.blogspot.com/2005/10/suggestion-box.html">suggestion box</a> which is the best way to keep all the packages installed from <a href="http://www.pkgsrc.org/">pkgsrc</a> up to date.  I must confess that pkgsrc is quite weak in the updating area when compared to systems such as apt-get or yum.  The problem comes from the fact that pkgsrc is a source-based packaging system, meaning that the end user builds packages by himself most of the times.  Doing updates from such a system is hard because rebuilds take a long time and have high chances of breaking, leaving your system in an unusable status.   Of course there is support for binary packages in pkgsrc, but we are not doing a good job in providing good sets of prebuilt binaries.   Furthermore, and as drio stated, there is few documentation on the subject.<br /><br />The thing is there are several ways of updating all your installed packages.  All of them are quite tedious and not "official", but with some work you can configure some scripts and cron jobs to automate the process as much as possible.<br /><br />Before doing an update, I usually start by running <tt>pkg_chk -u -n</tt>; this tells me which packages are out of date and which are their new versions.  If the resulting list is short, I tend to follow the <tt>make replace</tt> procedure.  This only works if the new versions of the packages are <i>binary compatible</i> with the old ones, something that you cannot guarantee by looking at the version numbers.  For example, you can assume that if you have version X.Y.A from the libfoo library, the newer X.Y.B will be compatible to the old one.  This is generally true but not always.  Plus you need to have some knowledge of the dependency graph of your installed packages.   Anyway, if you want to take the risk, simply go to the pkgsrc's directory for the outdated packages and run <tt>make replace</tt> in them.  In most cases this works and is the fastest way to do minor updates.<br /><br />Things get worse when you have to update lots of stuff.  The first and most obvious approach resorts to doing a clean reinstall.  Start by issuing <tt>pkg_delete -r "*"</tt> followed by wiping <tt>/usr/pkg</tt> and <tt>/var/db/pkg</tt>.  Then rebuild your packages.  The problems with this approach are that it introduces a huge downtime in the system — until you have rebuilt everything (which can take a long time), the tools won't be available — and that any build failure can prevent you from reconfiguring your system soon enough.<br /><br />Another approach involves using different installation prefixes for the old and new installations.  I used to do that when working on major GNOME updates.  To do this set <tt>LOCALBASE</tt> to something like <tt>/usr/pkg-YYYYMMDD</tt> (similarly for <tt>PKG_SYSCONFBASE</tt>, <tt>VARBASE</tt> and <tt>PKG_DBDIR</tt>) where <tt>YYYYMMDD</tt> is the date when you started the installation of that specific set of packages.  Then install your packages as usual and at last create a <tt>/usr/pkg</tt> symlink to point to the real directory.  Do not change the date until you need to do major updates.  When that time comes, change the date in your configuration to the current day; after that, pkgsrc will think that you don't have any packages installed so you can cleanly reinstall everything.  Once you have finished installing all your packages again, update the <tt>/usr/pkg</tt> symlink to point to the new directory and remove the old one.  Voila, minimum downtime and build failures cannot bother you.  (However, you will need to migrate configuration files to the new tree, for example.)<br /><br />The last approach I can think of involves using <tt>pkg_comp</tt>.  Use this tool to configure a sandbox in which you build <i>binary packages</i> for all the stuff you are interested in.  You can even set up a cron job to do this rebuild weekly, for example, which is trivial using the tool's <tt>auto</tt> target.  Once <tt>pkg_comp</tt> has generated a clean set of binary packages for you, you can proceed to update your real system with those packages.  The way you proceed is up to you though.  You can remove everything and do a clean reinstall (which should be a quick process anyway because you needn't rebuild anything!) or use <tt>pkg_add -u</tt> for the outdated packages.  I think this is the safest way to proceed.<br /><br />Oh, I now notice that there is a <tt>pkg_rolling-replace</tt> utility that can also be used for updates.  Dunno how it works though.<br /><br />Hope this makes any sense!<br /><br /><b>Edit (22:15)</b>: Peter Bex refers us to the <a href="http://wiki.netbsd.se/index.php/How_to_upgrade_packages">How to upgrade packages</a> page in the unofficial NetBSD Wiki.  It contains all these tricks plus many more, so it is worth to link it from here for completeness.
