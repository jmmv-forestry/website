---
layout: post
title: "Updating the pkgsrc GNOME packages"
date: 2006-01-05 15:09:00 -0500
categories:
julipedia: 2006/01/updating-pkgsrc-gnome-packages.html
excerpt: Post imported from The Julipedia; excerpt not available.
---
A while ago, somebody called John <a href="http://julipedia.blogspot.com/2005/10/suggestion-box.html">asked me</a> to explain the process I follow when I update the <a href="http://www.gnome.org/">GNOME</a> packages in <a href="http://www.pkgsrc.org/">pkgsrc</a>.  As I'll be doing this again in a few days (to bring 2.12.2 into the tree), this seems a good moment for the essay.  Here I go:<br /><br />The first thing I do is to fetch the whole distribution from the FTP site; i.e., the <tt>platform</tt> and <tt>desktop</tt> directories located under the latest stable version.  I have a little script that does this for me, avoiding to fetch the distfiles that haven't changed since the previous version.<br /><br />Once this is done I generate a list of all the downloaded distfiles and adjust the package dependencies in <tt>meta-pkgs/gnome-devel/Makefile</tt>, <tt>meta-pkgs/gnome-base/Makefile</tt> and <tt>meta-pkgs/gnome/Makefile</tt> to require the new versions; this includes adding any possible new stuff.  I do this manually, which is a quite boring task; however, writing a script could take much more time.<br /><br />Afterward, I use <tt>cvs diff -u meta-pkgs/gnome* | grep '^+'</tt> over the modified files to get a list of the packages that need to be updated.  As the list of dependencies in the meta-packages is sorted in reverse order &mdash; i.e., a package in the n-th position uses packages in the 1..n-1 positions but not any in the n+1..N ones &mdash; this command creates a useful "step by step" guide of what needs to be done.<br /><br />Then, it is a matter of updating all the packages that need it, which is, by far, the longest part of the process.  I go one by one, bumping their version, building them, installing the results, ensuring the <tt>PLIST</tt> is correct, and generating a <tt>log</tt> file in the same directory that will serve me during the commit part.  I also have a little script that automates most of this stuff for a given package &mdash; and, thanks to <tt>verifypc</tt>, this is relatively quick :-)<br /><br />In the last part described, there are some packages that always scare me due to the portability problems that plague them over and over again.  These include the ones that try to access the hardware to get information, to control multimedia peripherals, to manage network stuff, etc.  I don't know why some packages break in similar places in newer versions even if the mainstream developers have been sent some patches to fix the stuff in previous versions.  &lt;/rant&gt;<br /><br />Once I've got the updated <tt>gnome-base</tt> package installed, I zap all my GNOME configuration &mdash; <tt>~/.gconf*</tt>, <tt>~/.nautilus*</tt>, <tt>~/.metacity*</tt>, <tt>~/.gnome*</tt> and a lot more garbage &mdash; and try to start it.  At this point, it is mostly useless, but I can see if there are serious problems in any of the most basic libraries.  If so, this is the time to go for some bug hunting!<br /><br />When the <tt>gnome-base</tt> package works, I continue to update all the other missing packages and try to package the new ones, if any.  Adding new stuff is not easy in general (portability bugs again) and this is why some of the dependencies are still commented out in the meta-packages.  Anyway, with this done, I finally start the complete desktop and check if there are any major problems with the most "important" applications.  Again, if there are any, it is a good time to solve them.<br /><br />So all the updates are done, but nobody guarantees that they work, specially because I do all the work under NetBSD-current.  So I generally (but not always... shame on me!) use <tt>pkg_comp</tt> to check that they work, at the very least, under the latest stable release (3.0 at this point).<br /><br />The last part is to commit all the stuff in a short time window to minimize pain to end users.  Even though I have left <tt>log</tt> files all around and prepared the correct entries for the <tt>CHANGES</tt> file, this often takes more than an hour.<br /><br />Unfortunately, end users always suffer, either because the packages break on their platform, because our packaging updating tools suck or simply because I made some mistake (e.g., forgot to commit something).  But this is what pkgsrc-current is for, isn't it?  ;-)<br /><br />And, of course, another thing to do is to review all the newly added local patches, clean them up, adapt them to the development versions of their corresponding packages and submit them to <a href="http://bugzilla.gnome.org/">GNOME's bugzilla</a>.  This is gratifying, but also a big, big pain.<br /><br />Well, well... this has been quite long, but I think I haven't left anything out.
