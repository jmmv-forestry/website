---
layout: post
title: "The AM_GCONF_SOURCE_2 macro"
date: 2004-10-01 17:45:00 -0400
categories:
julipedia: 2004/10/amgconfsource2-macro.html
excerpt_separator: </p>
---
<p><a href="http://www.gnome.org/projects/gconf/">GConf</a> comes with an m4 file to ease its usage from third party configure scripts; it provides a macro, known as <tt>AM_GCONF_SOURCE_2</tt>, which provides many features (and most importantly, encapsulates all GConf related stuff). Among these, it is used to determine the directory where <tt>.schemas</tt> files should be installed, a setting that can be fine-tuned by the end user through the <tt>--with-gconf-schema-file-dir</tt> argument.</p>  <p>However, many configure scripts use this macro incorrectly. That is, they call it from the configure script to detect the presence of <tt>gconftool-2</tt>, but later, in <tt>Makefile.am</tt> files, they don't use the variables defined by the macro.</p>  <p>For example, resuming my previous example: I've found lots of packages that have this in their <tt>Makefile.am</tt>:</p>  <pre>schemasdir = $(sysconfdir)/gconf/schemas</pre>  <p>To (almost) all Linux users, this will look completely sane, as that is the usual directory where schemas get installed. But this will fail miserably if the user has chosen another location (for example, <a href="http://www.pkgsrc.org/">pkgsrc</a> uses <tt>/usr/pkg/share/gconf/schemas</tt> to store them). The solution is very simple, because all you have to do is to use a variable defined by the macro; that is, the <tt>Makefile.am</tt> has to be modified to say:</p>  <pre>schemasdir = $(GCONF_SCHEMA_FILE_DIR)</pre>  <p>Another problem I often find comes from the usage of the <tt>GCONF_SCHEMAS_INSTALL</tt> conditional, also defined by that macro.  This conditional is provided to determine whether <tt>gconftool-2</tt> has to be executed during a <tt>make install</tt> to register the schemas into GConf's system-wide database or not.  Some <tt>Makefile.am</tt> files don't use this feature at all; others fail to define the "false" case, leading to problems with the BSD Make utility ("missing target").</p>  <p>Consider that you have the following code:</p>  <pre>install-data-local: install-schemas<br />install-schemas:<br />       GCONF_CONFIG_SOURCE=$(GCONF_SCHEMA_CONFIG_SOURCE)            $(GCONFTOOL) --makefile-install-rule foobar.schemas</pre><p></p>  <p>You should rewrite it to look like the following code; i.e., surround it with an Automake conditional, and define the <tt>install-data-local</tt> in the "false" case to do nothing.  This fixes the two problems mentioned previously:</p>  <pre>if GCONF_SCHEMAS_INSTALL<br />install-data-local: install-schemas<br />install-schemas:<br />       GCONF_CONFIG_SOURCE=$(GCONF_SCHEMA_CONFIG_SOURCE)            $(GCONFTOOL) --makefile-install-rule foobar.schemas<br />else<br />install-data-local:<br />endif</pre><p></p><p class="mobile-post"></p>
