.PHONY: default
default: Makefile scripts serve

# TODO(jmmv): Should automatically reinvoke configure... but this is difficult
# because we need to remember the flags originally passed by the user, and
# we need to tell make to reload the Makefile somehow.
Makefile: configure Makefile.in
	@echo "Makefile out of date; rerun ./configure with desired args"
	@false

.PHONY: clean-site
clean-site:
	rm -rf public
	mkdir public

.PHONY: build serve
build:
	$(HUGO)
	@# Create compatibility feed for Blogger subscriptions.
	mkdir -p public/feeds/posts/
	cp -f public/feed.xml public/feeds/posts/default

serve:
	$(HUGO) serve

.PHONY: scripts
scripts: _admin/html-to-markdown \
         _admin/import-blogger \
         _admin/publish-site

CLEANFILES += _admin/html-to-markdown
_admin/html-to-markdown: _admin/html-to-markdown.sh
	shtk build -o $@ $<

CLEANFILES += _admin/import-blogger
_admin/import-blogger: _admin/import-blogger.sh
	shtk build -o $@ $<

CLEANFILES += _admin/publish-site
_admin/publish-site: _admin/publish-site.sh
	shtk build -o $@ $<

.PHONY: import
import: import-blogger

.PHONY: import-blogger
import-blogger: _admin/import-blogger external/julipedia/blog-04-23-2016.xml
	./_admin/import-blogger external/julipedia/blog-04-23-2016.xml

.PHONY: publish
publish: build _admin/publish-site
	@if [ "$$(git status --porcelain)" != '' ]; then \
		echo 'Work directory not clean; refusing push' 1>&2; \
		exit 1; \
	fi
	./_admin/publish-site public $(LIVE_REPOSITORY)

.PHONY: clean
clean:
	rm -rf $(CLEANFILES)

.PHONY: cleandir
distclean: clean
	rm -rf $(DISTCLEANFILES)
